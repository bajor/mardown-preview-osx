name: Secret Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  detect-secrets:
    name: Detect Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets
        run: |
          detect-secrets scan --all-files --exclude-files '\.git/.*' > .secrets-report.json

          # Check if any secrets were found
          SECRETS_COUNT=$(python3 -c "import json; data=json.load(open('.secrets-report.json')); print(sum(len(v) for v in data.get('results', {}).values()))")

          if [ "$SECRETS_COUNT" -gt 0 ]; then
            echo "::error::Found $SECRETS_COUNT potential secrets!"
            cat .secrets-report.json
            exit 1
          fi

          echo "No secrets detected by detect-secrets"

  sensitive-data-scan:
    name: Sensitive Data & Artifact Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for sensitive patterns
        shell: bash
        run: |
          FOUND_ISSUES=0

          echo "=== Scanning for hardcoded secrets and sensitive data ==="

          # Function to check pattern
          check_pattern() {
            local name="$1"
            local pattern="$2"
            echo "Checking for: $name"
            if grep -rPn "$pattern" --include="*" --exclude-dir=".git" --exclude="secret-scanning.yml" --exclude="*.md" . 2>/dev/null; then
              echo "::error::Found potential $name!"
              return 1
            fi
            return 0
          }

          # Check for various secret patterns
          check_pattern "API Keys" '(?i)(api[_-]?key|apikey)\s*[:=]\s*["\x27]?[a-zA-Z0-9_\-]{20,}' || FOUND_ISSUES=1
          check_pattern "AWS Access Keys" '(AKIA|ABIA|ACCA|ASIA)[A-Z0-9]{16}' || FOUND_ISSUES=1
          check_pattern "AWS Secret Keys" '(?i)aws[_-]?secret[_-]?access[_-]?key\s*[:=]\s*["\x27]?[A-Za-z0-9/+=]{40}' || FOUND_ISSUES=1
          check_pattern "Private Keys" '-----BEGIN (RSA |DSA |EC |OPENSSH |PGP )?PRIVATE KEY' || FOUND_ISSUES=1
          check_pattern "GitHub Tokens" 'gh[pousr]_[A-Za-z0-9_]{36,}' || FOUND_ISSUES=1
          check_pattern "Slack Tokens" 'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}' || FOUND_ISSUES=1
          check_pattern "Google API Keys" 'AIza[0-9A-Za-z\-_]{35}' || FOUND_ISSUES=1
          check_pattern "JWT Tokens" 'eyJ[A-Za-z0-9_-]{10,}\.eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}' || FOUND_ISSUES=1
          check_pattern "Generic Passwords" '(?i)(password|passwd|pwd)\s*[:=]\s*["\x27][^\s"\x27]{8,}["\x27]' || FOUND_ISSUES=1

          echo ""
          echo "=== Checking for files that should not be committed ==="

          # Check for cached/artifact files using a simple list
          check_cached_files() {
            local pattern="$1"
            if find . -name "$pattern" -not -path "./.git/*" 2>/dev/null | grep -q .; then
              echo "::error::Found cached/artifact files matching: $pattern"
              find . -name "$pattern" -not -path "./.git/*" 2>/dev/null
              return 1
            fi
            return 0
          }

          check_cached_files "*.pyc" || FOUND_ISSUES=1
          check_cached_files "*.pyo" || FOUND_ISSUES=1
          check_cached_files "__pycache__" || FOUND_ISSUES=1
          check_cached_files "*.class" || FOUND_ISSUES=1
          check_cached_files "*.jar" || FOUND_ISSUES=1
          check_cached_files "*.o" || FOUND_ISSUES=1
          check_cached_files "*.so" || FOUND_ISSUES=1
          check_cached_files "*.dylib" || FOUND_ISSUES=1
          check_cached_files "*.dll" || FOUND_ISSUES=1
          check_cached_files "*.exe" || FOUND_ISSUES=1
          check_cached_files "*.dSYM" || FOUND_ISSUES=1
          check_cached_files "node_modules" || FOUND_ISSUES=1
          check_cached_files ".cache" || FOUND_ISSUES=1
          check_cached_files "*.log" || FOUND_ISSUES=1
          check_cached_files "*.tmp" || FOUND_ISSUES=1
          check_cached_files "*.bak" || FOUND_ISSUES=1
          check_cached_files "*.swp" || FOUND_ISSUES=1
          check_cached_files ".DS_Store" || FOUND_ISSUES=1
          check_cached_files "Thumbs.db" || FOUND_ISSUES=1
          check_cached_files ".idea" || FOUND_ISSUES=1
          check_cached_files "*.sqlite" || FOUND_ISSUES=1
          check_cached_files "*.db" || FOUND_ISSUES=1

          echo ""
          echo "=== Checking for sensitive config files ==="

          # Check for environment files
          ENV_FILES=$(find . \( -name ".env" -o -name ".env.*" -o -name "*.env" \) -not -path "./.git/*" 2>/dev/null || true)
          if [ -n "$ENV_FILES" ]; then
            echo "::error::Found environment files that may contain secrets:"
            echo "$ENV_FILES"
            FOUND_ISSUES=1
          fi

          # Check for credential files (excluding workflow and docs)
          CRED_FILES=$(find . \( -name "credentials*" -o -name "*credential*" \) \
            -not -path "./.git/*" -not -name "*.yml" -not -name "*.yaml" -not -name "*.md" 2>/dev/null || true)
          if [ -n "$CRED_FILES" ]; then
            echo "::warning::Found potential credential files - please review:"
            echo "$CRED_FILES"
          fi

          echo ""
          echo "=== Scan Complete ==="

          if [ "$FOUND_ISSUES" -gt 0 ]; then
            echo "::error::Security scan found issues! Please review and fix before merging."
            exit 1
          fi

          echo "No critical issues found!"

  scan-summary:
    name: Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, detect-secrets, sensitive-data-scan]
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "=== Secret Scanning Summary ==="

          if [ "${{ needs.gitleaks.result }}" != "success" ]; then
            echo "::error::Gitleaks scan failed or found issues"
            exit 1
          fi

          if [ "${{ needs.trufflehog.result }}" != "success" ]; then
            echo "::error::TruffleHog scan failed or found issues"
            exit 1
          fi

          if [ "${{ needs.detect-secrets.result }}" != "success" ]; then
            echo "::error::detect-secrets scan failed or found issues"
            exit 1
          fi

          if [ "${{ needs.sensitive-data-scan.result }}" != "success" ]; then
            echo "::error::Sensitive data scan failed or found issues"
            exit 1
          fi

          echo "All security scans passed successfully!"
