name: Secret Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  detect-secrets:
    name: Detect Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets
        run: |
          detect-secrets scan --all-files --exclude-files '\.git/.*' > .secrets-report.json

          # Check if any secrets were found
          SECRETS_COUNT=$(python3 -c "import json; data=json.load(open('.secrets-report.json')); print(sum(len(v) for v in data.get('results', {}).values()))")

          if [ "$SECRETS_COUNT" -gt 0 ]; then
            echo "::error::Found $SECRETS_COUNT potential secrets!"
            cat .secrets-report.json
            exit 1
          fi

          echo "No secrets detected by detect-secrets"

  sensitive-data-scan:
    name: Sensitive Data & Artifact Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for sensitive patterns
        run: |
          set -e
          FOUND_ISSUES=0

          echo "=== Scanning for hardcoded secrets and sensitive data ==="

          # Define patterns to search for
          declare -A PATTERNS=(
            ["API Keys"]='(?i)(api[_-]?key|apikey)\s*[:=]\s*["\x27]?[a-zA-Z0-9_\-]{16,}'
            ["AWS Keys"]='(?i)(AKIA|ABIA|ACCA|ASIA)[A-Z0-9]{16}'
            ["AWS Secret"]='(?i)aws[_\-]?secret[_\-]?access[_\-]?key\s*[:=]\s*["\x27]?[A-Za-z0-9/+=]{40}'
            ["Private Keys"]='-----BEGIN (RSA |DSA |EC |OPENSSH |PGP )?PRIVATE KEY'
            ["Generic Secrets"]='(?i)(password|passwd|pwd|secret|token)\s*[:=]\s*["\x27][^\s"\x27]{8,}'
            ["GitHub Tokens"]='gh[pousr]_[A-Za-z0-9_]{36,}'
            ["Slack Tokens"]='xox[baprs]-[0-9]{10,13}-[0-9]{10,13}(-[a-zA-Z0-9]{24})?'
            ["Google API Key"]='AIza[0-9A-Za-z\-_]{35}'
            ["Heroku API Key"]='(?i)heroku[_\-]?api[_\-]?key\s*[:=]\s*[0-9a-fA-F]{8}-[0-9a-fA-F]{4}'
            ["JWT Tokens"]='eyJ[A-Za-z0-9_-]*\.eyJ[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*'
          )

          for pattern_name in "${!PATTERNS[@]}"; do
            echo "Checking for: $pattern_name"
            if grep -rPn "${PATTERNS[$pattern_name]}" --include="*" --exclude-dir=".git" --exclude="secret-scanning.yml" . 2>/dev/null; then
              echo "::error::Found potential $pattern_name!"
              FOUND_ISSUES=1
            fi
          done

          echo ""
          echo "=== Scanning for personal/sensitive information ==="

          # Email addresses (excluding common false positives)
          echo "Checking for: Email addresses"
          if grep -rPn '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' \
            --include="*.swift" --include="*.json" --include="*.plist" --include="*.yaml" --include="*.yml" \
            --include="*.env*" --include="*.config" --include="*.conf" \
            --exclude-dir=".git" --exclude="secret-scanning.yml" . 2>/dev/null | \
            grep -vE '(example\.com|test\.com|localhost|@users\.noreply\.github\.com)'; then
            echo "::warning::Found potential email addresses - please review"
          fi

          # Phone numbers (various formats)
          echo "Checking for: Phone numbers"
          if grep -rPn '(?<![0-9])(\+?1?[-.\s]?)?\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4}(?![0-9])' \
            --include="*.swift" --include="*.json" --include="*.plist" --include="*.yaml" --include="*.yml" \
            --exclude-dir=".git" --exclude="secret-scanning.yml" . 2>/dev/null | \
            grep -vE '(0000|1234|5555|test|example|mock)'; then
            echo "::warning::Found potential phone numbers - please review"
          fi

          echo ""
          echo "=== Checking for files that shouldn't be committed ==="

          # Check for cached/artifact files
          CACHED_PATTERNS=(
            "*.pyc"
            "*.pyo"
            "__pycache__"
            "*.class"
            "*.jar"
            "*.war"
            "*.o"
            "*.a"
            "*.so"
            "*.dylib"
            "*.dll"
            "*.exe"
            "*.dSYM"
            "node_modules"
            "vendor"
            ".cache"
            "*.log"
            "*.tmp"
            "*.temp"
            "*.bak"
            "*.swp"
            "*.DS_Store"
            "Thumbs.db"
            ".idea"
            ".vscode/settings.json"
            "*.sqlite"
            "*.db"
          )

          for pattern in "${CACHED_PATTERNS[@]}"; do
            if find . -name "$pattern" -not -path "./.git/*" 2>/dev/null | grep -q .; then
              echo "::error::Found cached/artifact files matching: $pattern"
              find . -name "$pattern" -not -path "./.git/*" 2>/dev/null
              FOUND_ISSUES=1
            fi
          done

          echo ""
          echo "=== Checking for sensitive config files ==="

          # Check for environment files with content
          ENV_FILES=$(find . -name ".env" -o -name ".env.*" -o -name "*.env" 2>/dev/null | grep -v ".git" || true)
          if [ -n "$ENV_FILES" ]; then
            echo "::error::Found environment files that may contain secrets:"
            echo "$ENV_FILES"
            FOUND_ISSUES=1
          fi

          # Check for credentials files
          CRED_FILES=$(find . \( -name "credentials*" -o -name "*credentials*" -o -name "secrets*" -o -name "*secret*" \) \
            -not -path "./.git/*" -not -name "secret-scanning.yml" -not -name "*.md" 2>/dev/null || true)
          if [ -n "$CRED_FILES" ]; then
            echo "::warning::Found potential credential files - please review:"
            echo "$CRED_FILES"
          fi

          # Check for config files that might contain sensitive data
          echo "Checking config files for sensitive patterns..."
          CONFIG_FILES=$(find . \( -name "*.config" -o -name "*.conf" -o -name "config.*" -o -name "settings.*" \) \
            -not -path "./.git/*" 2>/dev/null || true)

          for file in $CONFIG_FILES; do
            if grep -qPi '(password|secret|token|api[_-]?key|private[_-]?key)\s*[:=]' "$file" 2>/dev/null; then
              echo "::error::Config file may contain secrets: $file"
              FOUND_ISSUES=1
            fi
          done

          echo ""
          echo "=== Scan Complete ==="

          if [ "$FOUND_ISSUES" -gt 0 ]; then
            echo "::error::Security scan found issues! Please review and fix before merging."
            exit 1
          fi

          echo "No critical issues found!"

  scan-summary:
    name: Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, detect-secrets, sensitive-data-scan]
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "=== Secret Scanning Summary ==="

          if [ "${{ needs.gitleaks.result }}" != "success" ]; then
            echo "::error::Gitleaks scan failed or found issues"
            exit 1
          fi

          if [ "${{ needs.trufflehog.result }}" != "success" ]; then
            echo "::error::TruffleHog scan failed or found issues"
            exit 1
          fi

          if [ "${{ needs.detect-secrets.result }}" != "success" ]; then
            echo "::error::detect-secrets scan failed or found issues"
            exit 1
          fi

          if [ "${{ needs.sensitive-data-scan.result }}" != "success" ]; then
            echo "::error::Sensitive data scan failed or found issues"
            exit 1
          fi

          echo "All security scans passed successfully!"
